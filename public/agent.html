<!DOCTYPE html>
<html>
<head>
    <title>Support Agent Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        #status { padding: 10px; background: #f0f0f0; margin-bottom: 20px; }
        #agent-messages { height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; }
        .customer-msg { color: #d63384; margin: 5px 0; }
        .agent-msg { color: #0d6efd; margin: 5px 0; }
        .system-msg { color: #20c997; margin: 5px 0; }
        #agent-input { width: 70%; padding: 8px; }
        #send-btn, #end-chat-btn { padding: 8px 15px; }
        #notification { 
            display: none; 
            padding: 10px; 
            background: #fff3cd; 
            margin-bottom: 10px;
            border-left: 5px solid #ffc107;
        }
        #debug { 
            margin-top: 20px; 
            padding: 10px; 
            background: #f8f9fa; 
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>Live Support Dashboard</h1>
    <div id="status">Connecting to server...</div>
    <div id="notification">
        <strong id="notification-text"></strong>
        <button id="accept-btn">Accept Chat</button>
    </div>
    <div id="agent-messages"></div>
    <div>
        <input id="agent-input" placeholder="Type your response..." disabled>
        <button id="send-btn" disabled>Send</button>
        <button id="end-chat-btn" disabled>End Chat</button>
    </div>
    <div id="debug">
        <h3>Debug Console</h3>
        <div id="debug-log"></div>
    </div>

    <script>
        const debugLog = (message) => {
            const logDiv = document.getElementById('debug-log');
            logDiv.innerHTML += `${new Date().toLocaleTimeString()}: ${message}<br>`;
            console.log(message);
        };

        let ws;
        let currentSession = null;
        const agentId = `agent_${Math.random().toString(36).substr(2, 6)}`;

        function connectWebSocket() {
            ws = new WebSocket(`ws://${window.location.host}`);

            ws.onopen = () => {
                debugLog('WebSocket connected');
                const secretKey = prompt('Enter agent secret key:');
                ws.send(JSON.stringify({
                    type: 'agent_join',
                    agentId: agentId,
                    secretKey: secretKey
                }));
            };

            ws.onmessage = (e) => {
                debugLog(`Received: ${e.data}`);
                const data = JSON.parse(e.data);
                
                switch(data.type) {
                    case 'agent_status':
                        document.getElementById('status').textContent = data.message;
                        break;
                        
                    case 'pending_request':
                        document.getElementById('notification').style.display = 'block';
                        document.getElementById('notification-text').textContent = 
                            `New request (#${data.position} in queue): "${data.lastMessage}"`;
                        currentSession = data.sessionId;
                        break;
                        
                    case 'customer_assigned':
                        currentSession = data.sessionId;
                        document.getElementById('agent-input').disabled = false;
                        document.getElementById('send-btn').disabled = false;
                        document.getElementById('end-chat-btn').disabled = false;
                        document.getElementById('notification').style.display = 'none';
                        
                        const messagesDiv = document.getElementById('agent-messages');
                        messagesDiv.innerHTML = '<div class="system-msg">Chat started</div>';
                        
                        data.history.forEach(msg => {
                            const div = document.createElement('div');
                            div.className = msg.role === 'user' ? 'customer-msg' : 'bot-msg';
                            div.textContent = `${msg.role}: ${msg.content}`;
                            messagesDiv.appendChild(div);
                        });
                        break;
                        
                    case 'customer_message':
                        const msgDiv = document.createElement('div');
                        msgDiv.className = 'customer-msg';
                        msgDiv.textContent = `customer: ${data.message}`;
                        document.getElementById('agent-messages').appendChild(msgDiv);
                        document.getElementById('agent-messages').scrollTop = 
                            document.getElementById('agent-messages').scrollHeight;
                        break;
                }
            };

            ws.onclose = () => {
                debugLog('WebSocket disconnected - attempting to reconnect...');
                setTimeout(connectWebSocket, 3000);
            };

            ws.onerror = (err) => {
                debugLog(`WebSocket error: ${err.message}`);
            };
        }

        // Event listeners
        document.getElementById('accept-btn').addEventListener('click', () => {
            if (!currentSession) return;
            ws.send(JSON.stringify({
                type: 'accept_request',
                sessionId: currentSession,
                agentId: agentId
            }));
        });

        document.getElementById('send-btn').addEventListener('click', sendMessage);
        document.getElementById('agent-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        document.getElementById('end-chat-btn').addEventListener('click', () => {
            if (!currentSession) return;
            ws.send(JSON.stringify({
                type: 'end_chat',
                sessionId: currentSession
            }));
            currentSession = null;
            document.getElementById('agent-input').disabled = true;
            document.getElementById('send-btn').disabled = true;
            document.getElementById('end-chat-btn').disabled = true;
        });

        function sendMessage() {
            const input = document.getElementById('agent-input');
            const message = input.value.trim();
            if (!message || !currentSession) return;
            
            ws.send(JSON.stringify({
                type: 'agent_message',
                sessionId: currentSession,
                message: message
            }));
            
            const msgDiv = document.createElement('div');
            msgDiv.className = 'agent-msg';
            msgDiv.textContent = `you: ${message}`;
            document.getElementById('agent-messages').appendChild(msgDiv);
            input.value = '';
            document.getElementById('agent-messages').scrollTop = 
                document.getElementById('agent-messages').scrollHeight;
        }

        // Initialize
        connectWebSocket();
    </script>
</body>
</html>
